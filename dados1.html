<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adicionar Nome</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-image: linear-gradient(to right, #4facfe, #00f2fe);
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: #333;
      padding: 10px;
    }
    .container {
      max-width: 400px;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    input, select {
      margin: 10px 0;
      padding: 15px;
      width: 100%;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .btn-custom {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
    }
    #processingMessage {
      font-size: 24px;
      color: white;
    }
  </style>
</head>
<body>
<div class="container" id="mainContainer" style="display: none;">
  <h2>Adicione os seguintes dados:</h2>
  <div id="nameSection">

    <!-- Novo dropdown de ministério -->
    <select id="ministerioInput" class="form-control" required>
      <option value="">Selecione o Ministério</option>
      <option value="Ministério da Educação e Desenvolvimento Humano">Ministério da Educação e Desenvolvimento Humano</option>
      <option value="Ministério da Saúde">Ministério da Saúde</option>
      <option value="Ministério da Justiça, Assuntos Constitucionais e Religiosos">Ministério da Justiça, Assuntos Constitucionais e Religiosos</option>
      <option value="Ministério do Interior">Ministério do Interior</option>
      <option value="Ministério da Agricultura e Desenvolvimento Rural">Ministério da Agricultura e Desenvolvimento Rural</option>
      <option value="Ministério da Economia e Finanças">Ministério da Economia e Finanças</option>
      <option value="Ministério da Administração Estatal e Função Pública">Ministério da Administração Estatal e Função Pública</option>
    </select>

    <input type="text" id="nameInput" class="form-control" placeholder="Nome Completo" required>

    <select id="carreiraInput" class="form-control" required>
      <option value="">Selecione a Carreira</option>
      <option value="Carreira1">Carreira 1</option>
      <option value="Carreira2">Carreira 2</option>
      <option value="Carreira3">Carreira 3</option>
    </select>

    <select id="nomeacaoInput" class="form-control" required>
      <option value="">Selecione a Nomeação</option>
      <option value="Nomeacao1">Nomeação 1</option>
      <option value="Nomeacao2">Nomeação 2</option>
      <option value="Nomeacao3">Nomeação 3</option>
    </select>

    <select id="provinciaInput" class="form-control" required>
      <option value="">Selecione a província de trabalho</option>
      <option value="Manica">Manica</option>
      <option value="Sofala">Sofala</option>
      <option value="Tete">Tete</option>
    </select>

    <select id="distritoInput" class="form-control" required>
      <option value="">Selecione o distrito de trabalho</option>
    </select>

    <input type="text" id="celularContatoInput" class="form-control" placeholder="Número de Celular (Contato)" maxlength="9" required>
    <input type="text" id="celularPessoalInput" class="form-control" placeholder="Número de Celular (Pessoal)" maxlength="9" required>

    <!-- Dropdown com todos os distritos em ordem alfabética -->
    <select id="localDistritoInput" class="form-control">
      <option value="">Selecione os distritos pretendidos</option>
      <option value="Angónia">Angónia</option>
      <option value="Barué">Barué</option>
      <option value="Beira">Beira</option>
      <option value="Bilene">Bilene</option>
      <option value="Boane">Boane</option>
      <option value="Buzi">Buzi</option>
      <option value="Caia">Caia</option>
      <option value="Cambulatsitsi">Cambulatsitsi</option>
      <option value="Changara">Changara</option>
      <option value="Chibuto">Chibuto</option>
      <option value="Chimoio">Chimoio</option>
      <option value="Chiúre">Chiúre</option>
      <option value="Chókwè">Chókwè</option>
      <option value="Cidade de Maputo">Cidade de Maputo</option>
      <option value="Cuamba">Cuamba</option>
      <option value="Dondo">Dondo</option>
      <option value="Funhalouro">Funhalouro</option>
      <option value="Gorongosa">Gorongosa</option>
      <option value="Govuro">Govuro</option>
      <option value="Homoíne">Homoíne</option>
      <option value="Inhambane">Inhambane</option>
      <option value="Jangamo">Jangamo</option>
      <option value="Macossa">Macossa</option>
      <option value="Magude">Magude</option>
      <option value="Mandlakazi">Mandlakazi</option>
      <option value="Manhiça">Manhiça</option>
      <option value="Manica">Manica</option>
      <option value="Marávia">Marávia</option>
      <option value="Marromeu">Marromeu</option>
      <option value="Massinga">Massinga</option>
      <option value="Massingir">Massingir</option>
      <option value="Matola">Matola</option>
      <option value="Maxixe">Maxixe</option>
      <option value="Moamba">Moamba</option>
      <option value="Moatize">Moatize</option>
      <option value="Morrumbene">Morrumbene</option>
      <option value="Mossurize">Mossurize</option>
      <option value="Muanza">Muanza</option>
      <option value="Namaacha">Namaacha</option>
      <option value="Nhamatanda">Nhamatanda</option>
      <option value="Panda">Panda</option>
      <option value="Sussundenga">Sussundenga</option>
      <option value="Tete">Tete</option>
      <option value="Vanduzi">Vanduzi</option>
      <option value="Vilankulo">Vilankulo</option>
      <option value="Xai-Xai">Xai-Xai</option>
      <option value="Xinavane">Xinavane</option>
      <option value="Zavala">Zavala</option>
      <option value="Zumbo">Zumbo</option>
    </select>

    <input type="text" id="petendidoInput" class="form-control" placeholder="Local pretendido" required readonly>
    <input type="hidden" id="contactadoInput" value="não">

    <button id="submitButton" class="btn btn-primary mt-3 d-block mx-auto">OK</button>
    <a href="logout.html" style="text-decoration: underline; display: block; text-align: center;">Terminar sessão</a>
  </div>
  <p id="message" class="mt-3"></p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBisN5rWYAm1RULEtLt2Rr5rTOwoJoobyw",
    authDomain: "permutas-70e20.firebaseapp.com",
    projectId: "permutas-70e20",
    storageBucket: "permutas-70e20.appspot.com",
    messagingSenderId: "675438868569",
    appId: "1:675438868569:web:d46be8ea0e68c999505948"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Função que verifica se o usuário já tem dados preenchidos
  async function checkUserData() {
    const user = auth.currentUser;

    if (user) {
      const userDocRef = doc(db, 'users', user.uid);
      const userDocSnapshot = await getDoc(userDocRef);

      // Se o documento do usuário existir e tiver o campo 'name' preenchido
      if (userDocSnapshot.exists() && userDocSnapshot.data().name) {
        // Redireciona para a página home.html
        window.location.href = 'home.html';
      } else {
        // Exibe o formulário caso contrário
        document.getElementById('mainContainer').style.display = 'block'; // Exibe o conteúdo
      }
    } else {
      // Se não houver usuário autenticado, também exibe o formulário
      document.getElementById('mainContainer').style.display = 'block'; // Exibe o conteúdo
    }
  }

  // Verifica os dados do usuário logo após a autenticação
  auth.onAuthStateChanged((user) => {
    checkUserData();
  });

  // Código para a lógica de formulário (como já estava)
  const provinciaDistritosTrabalho = {
    "Manica": ["Barué", "Macossa", "Chimoio"],
    "Sofala": ["Beira", "Buzi", "Caia"],
    "Tete": ["Changara", "Tete", "Moatize"]
  };

  document.getElementById('provinciaInput').addEventListener('change', () => {
    const prov = document.getElementById('provinciaInput').value;
    const distritoSelect = document.getElementById('distritoInput');
    distritoSelect.innerHTML = '<option value="">Selecione o distrito</option>';
    if (provinciaDistritosTrabalho[prov]) {
      provinciaDistritosTrabalho[prov].forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        distritoSelect.appendChild(option);
      });
    }
  });

  let distritosSelecionados = []; // Para armazenar os distritos selecionados

  document.getElementById('localDistritoInput').addEventListener('change', () => {
    const val = document.getElementById('localDistritoInput').value;

    if (val && !distritosSelecionados.includes(val)) {
      distritosSelecionados.push(val); // Adiciona o distrito selecionado à lista
      // Atualiza o valor do dropdown para "Adicione outro distrito pretendido"
      document.getElementById('localDistritoInput').value = "";
      document.getElementById('localDistritoInput').options[0].text = "Adicione outro distrito pretendido";
    }
    // Atualiza o campo de texto com os distritos selecionados
    document.getElementById('petendidoInput').value = distritosSelecionados.join(', ');
  });

  document.getElementById('submitButton').addEventListener('click', async () => {
    const ministerio = document.getElementById('ministerioInput').value.trim();
    const name = document.getElementById('nameInput').value.trim();
    const carreira = document.getElementById('carreiraInput').value.trim();
    const nomeacao = document.getElementById('nomeacaoInput').value.trim();
    const provincia = document.getElementById('provinciaInput').value.trim();
    const distrito = document.getElementById('distritoInput').value.trim();
    const petendido = document.getElementById('petendidoInput').value.trim();
    const celularContato = document.getElementById('celularContatoInput').value.trim();
    const celularPessoal = document.getElementById('celularPessoalInput').value.trim();
    const contactado = document.getElementById('contactadoInput').value;
    const user = auth.currentUser;

    if (user && ministerio && name && carreira && nomeacao && provincia && distrito && celularContato && celularPessoal) {
      try {
        await setDoc(doc(db, 'users', user.uid), {
          email: user.email,
          ministerio,
          name,
          carreira,
          nomeacao,
          provincia,
          distrito,
          petendido,
          celular_contato: celularContato,
          celular_pessoal: celularPessoal,
          contactado
        });
        document.getElementById('message').innerText = 'Dados adicionados com sucesso!';
        window.location.href = 'home.html';
      } catch (error) {
        document.getElementById('message').innerText = 'Erro ao adicionar dados: ' + error.message;
      }
    } else {
      document.getElementById('message').innerText = 'Por favor, preencha todos os campos.';
    }
  });
</script>
</body>
</html>
